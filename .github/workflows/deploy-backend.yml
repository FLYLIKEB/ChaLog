name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Build application
        working-directory: ./backend
        run: npm run build

      - name: Create deployment package
        working-directory: ./backend
        run: |
          mkdir -p deploy-package
          cp -r dist deploy-package/
          cp package.json package-lock.json ecosystem.config.js deploy-package/
          tar -czf deploy.tar.gz -C deploy-package .

      - name: Configure SSH
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          # í™˜ê²½ ë³€ìˆ˜ í™•ì¸
          echo "ğŸ” í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
          echo "EC2_HOST: ${EC2_HOST:+ì„¤ì •ë¨ (ê¸¸ì´: ${#EC2_HOST})}${EC2_HOST:-âŒ ì„¤ì •ë˜ì§€ ì•ŠìŒ}"
          echo "EC2_USER: ${EC2_USER:+ì„¤ì •ë¨ (ê°’: '$EC2_USER')}${EC2_USER:-âŒ ì„¤ì •ë˜ì§€ ì•ŠìŒ}"
          echo "EC2_SSH_KEY: ${EC2_SSH_KEY:+ì„¤ì •ë¨ (ê¸¸ì´: ${#EC2_SSH_KEY})}${EC2_SSH_KEY:-âŒ ì„¤ì •ë˜ì§€ ì•ŠìŒ}"
          
          # í•„ìˆ˜ ë³€ìˆ˜ í™•ì¸ (ë¹ˆ ë¬¸ìì—´ë„ ì²´í¬)
          MISSING_SECRETS=()
          if [ -z "${EC2_HOST:-}" ] || [ "$EC2_HOST" = "" ]; then
            MISSING_SECRETS+=("EC2_HOST")
          fi
          if [ -z "${EC2_USER:-}" ] || [ "$EC2_USER" = "" ]; then
            MISSING_SECRETS+=("EC2_USER")
          fi
          if [ -z "${EC2_SSH_KEY:-}" ] || [ "$EC2_SSH_KEY" = "" ]; then
            MISSING_SECRETS+=("EC2_SSH_KEY")
          fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ í•„ìˆ˜ Secretsê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo "ëˆ„ë½ëœ Secrets:"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "  - $secret"
            done
            echo ""
            echo "ì„¤ì • ë°©ë²•:"
            echo "1. GitHub ì €ì¥ì†Œ â†’ Settings â†’ Secrets and variables â†’ Actions"
            echo "2. New repository secret í´ë¦­"
            echo "3. Nameê³¼ Secret ê°’ ì…ë ¥"
            echo ""
            echo "ìì„¸í•œ ë‚´ìš©: docs/GITHUB_SECRETS_CHECKLIST.md"
            exit 1
          fi
          
          echo "âœ… ëª¨ë“  í•„ìˆ˜ Secretsê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!"
          
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # SSH í‚¤ ì €ì¥ (ì¤„ë°”ê¿ˆ ë³´ì¡´)
          echo "$EC2_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # SSH í‚¤ í˜•ì‹ í™•ì¸
          echo "ğŸ”‘ SSH í‚¤ í˜•ì‹ í™•ì¸:"
          head -1 ~/.ssh/deploy_key
          tail -1 ~/.ssh/deploy_key
          echo "í‚¤ íŒŒì¼ í¬ê¸°: $(wc -c < ~/.ssh/deploy_key) bytes"
          
          # EC2 í˜¸ìŠ¤íŠ¸ í‚¤ ì¶”ê°€
          echo "ğŸ” EC2 í˜¸ìŠ¤íŠ¸ í‚¤ ì¶”ê°€ ì¤‘..."
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts 2>&1 || true
          chmod 644 ~/.ssh/known_hosts
          
          # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸ” SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -v \
              "$EC2_USER@$EC2_HOST" \
              "echo 'SSH ì—°ê²° ì„±ê³µ!'" || {
            echo "âš ï¸ SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ì´ ë‹¨ê³„ëŠ” ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤)"
          }

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          # í™˜ê²½ ë³€ìˆ˜ í™•ì¸
          if [ -z "${EC2_HOST:-}" ] || [ -z "${EC2_USER:-}" ]; then
            echo "âŒ EC2_HOST ë˜ëŠ” EC2_USERê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo "EC2_HOST: ${EC2_HOST:-âŒ ì—†ìŒ}"
            echo "EC2_USER: ${EC2_USER:-âŒ ì—†ìŒ}"
            exit 1
          fi
          
          echo "ğŸ” ë°°í¬ ëŒ€ìƒ: $EC2_USER@$EC2_HOST"
          
          # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸ” SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
          if ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              "$EC2_USER@$EC2_HOST" \
              "echo 'SSH ì—°ê²° ì„±ê³µ!'" 2>&1; then
            echo "âœ… SSH ì—°ê²° ì„±ê³µ!"
          else
            echo "âŒ SSH ì—°ê²° ì‹¤íŒ¨!"
            echo "EC2_SSH_KEY Secretì„ í™•ì¸í•˜ì„¸ìš”."
            echo "ìì„¸í•œ ë‚´ìš©: docs/SSH_KEY_TROUBLESHOOTING.md"
            exit 1
          fi
          
          # ë°°í¬ íŒŒì¼ ì „ì†¡
          echo "ğŸ“¤ ë°°í¬ íŒŒì¼ ì „ì†¡ ì¤‘..."
          scp -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              backend/deploy.tar.gz \
              "$EC2_USER@$EC2_HOST:/tmp/"

          # EC2ì—ì„œ ë°°í¬ ì‹¤í–‰
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              "$EC2_USER@$EC2_HOST" << 'ENDSSH'
            set -e
            
            BACKEND_DIR="/home/ubuntu/chalog-backend"
            
            # curl ì„¤ì¹˜ í™•ì¸
            if ! command -v curl &> /dev/null; then
              echo "ğŸ“¦ curl ì„¤ì¹˜ ì¤‘..."
              sudo apt-get update
              sudo apt-get install -y curl
            fi
            
            # Node.js ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            if ! command -v node &> /dev/null || ! command -v npm &> /dev/null; then
              echo "ğŸ“¦ Node.js/npmì´ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì¹˜ ì¤‘..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
              
              # PATH ì—…ë°ì´íŠ¸ (í˜„ì¬ ì„¸ì…˜ì— ë°˜ì˜)
              export PATH="/usr/bin:$PATH"
              
              # ì„¤ì¹˜ í™•ì¸
              if command -v node &> /dev/null && command -v npm &> /dev/null; then
                echo "âœ… Node.js ì„¤ì¹˜ ì™„ë£Œ: $(node --version)"
                echo "âœ… npm ì„¤ì¹˜ ì™„ë£Œ: $(npm --version)"
              else
                echo "âŒ Node.js/npm ì„¤ì¹˜ ì‹¤íŒ¨!"
                echo "ìˆ˜ë™ ì„¤ì¹˜ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                exit 1
              fi
            else
              echo "âœ… Node.js ì´ë¯¸ ì„¤ì¹˜ë¨: $(node --version)"
              echo "âœ… npm ì´ë¯¸ ì„¤ì¹˜ë¨: $(npm --version)"
            fi
            
            # npm ê²½ë¡œ í™•ì¸
            echo "ğŸ” npm ê²½ë¡œ: $(which npm)"
            echo "ğŸ” node ê²½ë¡œ: $(which node)"
            
            # ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p $BACKEND_DIR
            cd $BACKEND_DIR
            
            # ê¸°ì¡´ íŒŒì¼ ë°±ì—…
            if [ -d "dist" ]; then
              echo "ğŸ’¾ ê¸°ì¡´ íŒŒì¼ ë°±ì—… ì¤‘..."
              BACKUP_DIR="/home/ubuntu/backups"
              mkdir -p $BACKUP_DIR
              tar -czf $BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).tar.gz \
                  dist/ package.json package-lock.json ecosystem.config.js 2>/dev/null || true
            fi
            
            # ë°°í¬ íŒŒì¼ ì••ì¶• í•´ì œ
            echo "ğŸ“¦ ë°°í¬ íŒŒì¼ ì••ì¶• í•´ì œ ì¤‘..."
            tar -xzf /tmp/deploy.tar.gz -C $BACKEND_DIR
            
            # ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            npm ci --production
            
            # PM2 ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ“¦ PM2ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì¹˜ ì¤‘..."
              sudo npm install -g pm2
              echo "âœ… PM2 ì„¤ì¹˜ ì™„ë£Œ: $(pm2 --version)"
              
              # PM2 ë¶€íŒ… ì‹œ ìë™ ì‹œì‘ ì„¤ì •
              echo "âš™ï¸ PM2 ë¶€íŒ… ì‹œ ìë™ ì‹œì‘ ì„¤ì • ì¤‘..."
              pm2 startup systemd -u ubuntu --hp /home/ubuntu || echo "PM2 startup ì„¤ì •ì€ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            else
              echo "âœ… PM2 ì´ë¯¸ ì„¤ì¹˜ë¨: $(pm2 --version)"
            fi
            
            # PM2ë¡œ ì¬ì‹œì‘
            echo "ğŸ”„ PM2ë¡œ ì•± ì¬ì‹œì‘ ì¤‘..."
            pm2 delete chalog-backend 2>/dev/null || true
            pm2 start ecosystem.config.js
            pm2 save
            
            # Health check
            echo "ğŸ¥ Health check..."
            sleep 5
            if curl -f http://localhost:3000/health > /dev/null 2>&1; then
              echo "âœ… ë°°í¬ ì„±ê³µ! Health check í†µê³¼"
            else
              echo "âš ï¸ Health check ì‹¤íŒ¨. ë¡œê·¸ í™•ì¸:"
              pm2 logs chalog-backend --lines 20 --nostream
              exit 1
            fi
            
            # ì •ë¦¬
            rm -f /tmp/deploy.tar.gz
          ENDSSH

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -rf backend/deploy-package backend/deploy.tar.gz

      - name: Deployment Summary
        if: success()
        run: |
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ Backend URL: http://${{ secrets.EC2_HOST }}:3000"
          echo "ğŸ¥ Health Check: http://${{ secrets.EC2_HOST }}:3000/health"

