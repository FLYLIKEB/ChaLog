name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Build application
        working-directory: ./backend
        run: npm run build

      - name: Create deployment package
        working-directory: ./backend
        run: |
          mkdir -p deploy-package
          cp -r dist deploy-package/
          cp package.json package-lock.json ecosystem.config.js deploy-package/
          tar -czf deploy.tar.gz -C deploy-package .

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          # ë°°í¬ íŒŒì¼ ì „ì†¡
          scp -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              backend/deploy.tar.gz \
              $EC2_USER@$EC2_HOST:/tmp/

          # EC2ì—ì„œ ë°°í¬ ì‹¤í–‰
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e
            
            BACKEND_DIR="/home/ubuntu/chalog-backend"
            
            # ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p $BACKEND_DIR
            cd $BACKEND_DIR
            
            # ê¸°ì¡´ íŒŒì¼ ë°±ì—…
            if [ -d "dist" ]; then
              echo "ğŸ’¾ ê¸°ì¡´ íŒŒì¼ ë°±ì—… ì¤‘..."
              BACKUP_DIR="/home/ubuntu/backups"
              mkdir -p $BACKUP_DIR
              tar -czf $BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).tar.gz \
                  dist/ package.json package-lock.json ecosystem.config.js 2>/dev/null || true
            fi
            
            # ë°°í¬ íŒŒì¼ ì••ì¶• í•´ì œ
            echo "ğŸ“¦ ë°°í¬ íŒŒì¼ ì••ì¶• í•´ì œ ì¤‘..."
            tar -xzf /tmp/deploy.tar.gz -C $BACKEND_DIR
            
            # ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            npm ci --production
            
            # PM2ë¡œ ì¬ì‹œì‘
            echo "ğŸ”„ PM2ë¡œ ì•± ì¬ì‹œì‘ ì¤‘..."
            pm2 delete chalog-backend 2>/dev/null || true
            pm2 start ecosystem.config.js
            pm2 save
            
            # Health check
            echo "ğŸ¥ Health check..."
            sleep 5
            if curl -f http://localhost:3000/health > /dev/null 2>&1; then
              echo "âœ… ë°°í¬ ì„±ê³µ! Health check í†µê³¼"
            else
              echo "âš ï¸ Health check ì‹¤íŒ¨. ë¡œê·¸ í™•ì¸:"
              pm2 logs chalog-backend --lines 20 --nostream
              exit 1
            fi
            
            # ì •ë¦¬
            rm -f /tmp/deploy.tar.gz
          ENDSSH

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -rf backend/deploy-package backend/deploy.tar.gz

      - name: Deployment Summary
        if: success()
        run: |
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ Backend URL: http://${{ secrets.EC2_HOST }}:3000"
          echo "ğŸ¥ Health Check: http://${{ secrets.EC2_HOST }}:3000/health"

