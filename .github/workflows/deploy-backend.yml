name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for package-lock.json
        id: check_lockfile
        working-directory: ./backend
        run: |
          if [ -f package-lock.json ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: ${{ steps.check_lockfile.outputs.exists == 'true' && 'npm' || '' }}
          cache-dependency-path: ${{ steps.check_lockfile.outputs.exists == 'true' && 'backend/package-lock.json' || '' }}

      - name: Ensure package-lock.json exists
        if: steps.check_lockfile.outputs.exists == 'false'
        working-directory: ./backend
        run: |
          echo "âš ï¸ package-lock.jsonì´ ì—†ìŠµë‹ˆë‹¤. ìƒì„± ì¤‘..."
          npm install --package-lock-only --legacy-peer-deps --no-workspaces

      - name: Install dependencies
        working-directory: ./backend
        env:
          NPM_CONFIG_WORKSPACES: "false"
          NPM_CONFIG_LEGACY_PEER_DEPS: "true"
        run: |
          echo "ğŸ“¦ npm ci (--no-workspaces) ì‹¤í–‰ ì¤‘..."
          if ! npm ci --legacy-peer-deps --no-workspaces --include-workspace-root=false; then
            echo "âŒ npm ci ì‹¤íŒ¨!"
            echo "package-lock.jsonê³¼ package.jsonì„ ë™ê¸°í™”í•œ ë’¤ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”."
            exit 1
          fi
          
          REQUIRED_PACKAGES=("typeorm" "@nestjs/typeorm" "@nestjs/common" "@nestjs/core" "class-transformer" "class-validator" "rxjs" "mysql2")
          echo "ğŸ” í•„ìˆ˜ íŒ¨í‚¤ì§€ í™•ì¸ ì¤‘..."
          for pkg in "${REQUIRED_PACKAGES[@]}"; do
            if [ -d "node_modules/$pkg" ]; then
              echo "âœ… $pkg í™•ì¸ë¨"
            else
              echo "âŒ $pkg ëˆ„ë½ë¨! package.jsonì„ í™•ì¸í•˜ì„¸ìš”."
              exit 1
            fi
          done

      - name: Build application
        working-directory: ./backend
        run: |
          if [ ! -d "node_modules/typeorm" ]; then
            echo "âŒ typeorm ëˆ„ë½! package.jsonì„ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi
          npm run build

      - name: Create deployment package
        working-directory: ./backend
        run: |
          mkdir -p deploy-package
          cp -r dist deploy-package/
          cp package.json package-lock.json ecosystem.config.js deploy-package/
          # package-lock.jsonì´ ì—†ìœ¼ë©´ ìƒì„±
          if [ ! -f package-lock.json ]; then
            echo "âš ï¸ package-lock.jsonì´ ì—†ìŠµë‹ˆë‹¤. ìƒì„± ì¤‘..."
            npm install --package-lock-only
          fi
          tar -czf deploy.tar.gz -C deploy-package .

      - name: Configure SSH
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          # í™˜ê²½ ë³€ìˆ˜ í™•ì¸
          echo "ğŸ” í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
          echo "EC2_HOST: ${EC2_HOST:+ì„¤ì •ë¨ (ê¸¸ì´: ${#EC2_HOST})}${EC2_HOST:-âŒ ì„¤ì •ë˜ì§€ ì•ŠìŒ}"
          echo "EC2_USER: ${EC2_USER:+ì„¤ì •ë¨ (ê°’: '$EC2_USER')}${EC2_USER:-âŒ ì„¤ì •ë˜ì§€ ì•ŠìŒ}"
          echo "EC2_SSH_KEY: ${EC2_SSH_KEY:+ì„¤ì •ë¨ (ê¸¸ì´: ${#EC2_SSH_KEY})}${EC2_SSH_KEY:-âŒ ì„¤ì •ë˜ì§€ ì•ŠìŒ}"
          
          # í•„ìˆ˜ ë³€ìˆ˜ í™•ì¸ (ë¹ˆ ë¬¸ìì—´ë„ ì²´í¬)
          MISSING_SECRETS=()
          if [ -z "${EC2_HOST:-}" ] || [ "$EC2_HOST" = "" ]; then
            MISSING_SECRETS+=("EC2_HOST")
          fi
          if [ -z "${EC2_USER:-}" ] || [ "$EC2_USER" = "" ]; then
            MISSING_SECRETS+=("EC2_USER")
          fi
          if [ -z "${EC2_SSH_KEY:-}" ] || [ "$EC2_SSH_KEY" = "" ]; then
            MISSING_SECRETS+=("EC2_SSH_KEY")
          fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ í•„ìˆ˜ Secretsê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo "ëˆ„ë½ëœ Secrets:"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "  - $secret"
            done
            echo ""
            echo "ì„¤ì • ë°©ë²•:"
            echo "1. GitHub ì €ì¥ì†Œ â†’ Settings â†’ Secrets and variables â†’ Actions"
            echo "2. New repository secret í´ë¦­"
            echo "3. Nameê³¼ Secret ê°’ ì…ë ¥"
            echo ""
            echo "ìì„¸í•œ ë‚´ìš©: docs/GITHUB_SECRETS_CHECKLIST.md"
            exit 1
          fi
          
          echo "âœ… ëª¨ë“  í•„ìˆ˜ Secretsê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!"
          
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # SSH í‚¤ ì €ì¥ (ì¤„ë°”ê¿ˆ ë³´ì¡´)
          echo "$EC2_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # SSH í‚¤ í˜•ì‹ í™•ì¸
          echo "ğŸ”‘ SSH í‚¤ í˜•ì‹ í™•ì¸:"
          head -1 ~/.ssh/deploy_key
          tail -1 ~/.ssh/deploy_key
          echo "í‚¤ íŒŒì¼ í¬ê¸°: $(wc -c < ~/.ssh/deploy_key) bytes"
          echo "í‚¤ íŒŒì¼ ì¤„ ìˆ˜: $(wc -l < ~/.ssh/deploy_key) ì¤„"
          
          # SSH í‚¤ í˜•ì‹ ê²€ì¦
          if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/deploy_key; then
            echo "âŒ SSH í‚¤ í˜•ì‹ ì˜¤ë¥˜: 'BEGIN PRIVATE KEY'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            echo "EC2_SSH_KEY Secretì´ ì˜¬ë°”ë¥¸ í˜•ì‹ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi
          
          if ! grep -q "END.*PRIVATE KEY" ~/.ssh/deploy_key; then
            echo "âŒ SSH í‚¤ í˜•ì‹ ì˜¤ë¥˜: 'END PRIVATE KEY'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            echo "EC2_SSH_KEY Secretì´ ì˜¬ë°”ë¥¸ í˜•ì‹ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi
          
          echo "âœ… SSH í‚¤ í˜•ì‹ ê²€ì¦ í†µê³¼"
          
          # EC2 í˜¸ìŠ¤íŠ¸ í‚¤ ì¶”ê°€
          echo "ğŸ” EC2 í˜¸ìŠ¤íŠ¸ í‚¤ ì¶”ê°€ ì¤‘..."
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts 2>&1 || true
          chmod 644 ~/.ssh/known_hosts
          
          # SSH ì—°ê²° í…ŒìŠ¤íŠ¸ (ìƒì„¸ ë¡œê·¸)
          echo "ğŸ” SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
          echo "í…ŒìŠ¤íŠ¸ ëª…ë ¹ì–´: ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST 'echo ì—°ê²° ì„±ê³µ'"
          echo ""
          
          # SSH í‚¤ì—ì„œ ê³µê°œ í‚¤ ì¶”ì¶œ ì‹œë„ (ë””ë²„ê¹…ìš©)
          echo "ğŸ“‹ SSH í‚¤ ì •ë³´:"
          echo "   í‚¤ íŒŒì¼ í¬ê¸°: $(wc -c < ~/.ssh/deploy_key) bytes"
          echo "   í‚¤ íŒŒì¼ ì¤„ ìˆ˜: $(wc -l < ~/.ssh/deploy_key) lines"
          echo ""
          
          # ê³µê°œ í‚¤ ì¶”ì¶œ ì‹œë„ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
          echo "ğŸ”‘ ê³µê°œ í‚¤ ì¶”ì¶œ ì‹œë„ ì¤‘..."
          PUBLIC_KEY=$(ssh-keygen -y -f ~/.ssh/deploy_key 2>&1) || PUBLIC_KEY="ê³µê°œ í‚¤ ì¶”ì¶œ ì‹¤íŒ¨: $PUBLIC_KEY"
          echo "   ê³µê°œ í‚¤ (ì²˜ìŒ 100ì): ${PUBLIC_KEY:0:100}..."
          echo ""
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "SSH ì—°ê²° í…ŒìŠ¤íŠ¸ (DEBUG ëª¨ë“œ)..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # SSH ì—°ê²° í…ŒìŠ¤íŠ¸ (ì§ì ‘ ì‹¤í–‰í•˜ì—¬ ì¦‰ì‹œ ì¶œë ¥)
          if ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              -o LogLevel=DEBUG3 \
              -vvv \
              "$EC2_USER@$EC2_HOST" \
              "echo 'SSH ì—°ê²° ì„±ê³µ!'" 2>&1; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            SSH_EXIT=$?
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (exit code: $SSH_EXIT)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ğŸ” ë¬¸ì œ ì§„ë‹¨:"
            echo ""
            echo "1. EC2_SSH_KEY Secret í™•ì¸:"
            echo "   - GitHub ì €ì¥ì†Œ â†’ Settings â†’ Secrets â†’ EC2_SSH_KEY"
            echo "   - ì²« ì¤„: '-----BEGIN RSA PRIVATE KEY-----' ë˜ëŠ” '-----BEGIN OPENSSH PRIVATE KEY-----'"
            echo "   - ë§ˆì§€ë§‰ ì¤„: '-----END RSA PRIVATE KEY-----' ë˜ëŠ” '-----END OPENSSH PRIVATE KEY-----'"
            echo ""
            echo "2. EC2 ì¸ìŠ¤í„´ìŠ¤ì— ê³µê°œ í‚¤ ì¶”ê°€ í•„ìš”:"
            echo "   EC2 í‚¤ í˜ì–´: summy"
            echo "   Public IP: $EC2_HOST"
            echo ""
            echo "   ë¡œì»¬ì—ì„œ ì‹¤í–‰:"
            echo "   # 1. ê¸°ì¡´ í‚¤ë¡œ EC2 ì ‘ì†"
            echo "   ssh -i ~/.ssh/summy.pem ubuntu@$EC2_HOST"
            echo ""
            echo "   # 2. EC2ì—ì„œ ê³µê°œ í‚¤ í™•ì¸"
            echo "   cat ~/.ssh/authorized_keys"
            echo ""
            echo "   # 3. GitHub Actionsìš© ê³µê°œ í‚¤ ì¶”ê°€ (ë¡œì»¬ì—ì„œ)"
            echo "   ssh-keygen -y -f ~/.ssh/deploy_key.pem | ssh -i ~/.ssh/summy.pem ubuntu@$EC2_HOST 'cat >> ~/.ssh/authorized_keys'"
            echo ""
            echo "3. EC2 ì‚¬ìš©ìëª… í™•ì¸:"
            echo "   í˜„ì¬ ì„¤ì •: $EC2_USER"
            echo "   Ubuntu: ubuntu"
            echo "   Amazon Linux: ec2-user"
            echo ""
            echo "âš ï¸ ì´ ë‹¨ê³„ëŠ” ê³„ì† ì§„í–‰ë˜ì§€ë§Œ, ë°°í¬ ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          fi

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_DATABASE_URL: ${{ secrets.EC2_DATABASE_URL }}
          EC2_JWT_SECRET: ${{ secrets.EC2_JWT_SECRET }}
          EC2_FRONTEND_URL: ${{ secrets.EC2_FRONTEND_URL }}
          EC2_FRONTEND_URLS: ${{ secrets.EC2_FRONTEND_URLS }}
        run: |
          # í™˜ê²½ ë³€ìˆ˜ í™•ì¸
          if [ -z "${EC2_HOST:-}" ] || [ -z "${EC2_USER:-}" ]; then
            echo "âŒ EC2_HOST ë˜ëŠ” EC2_USERê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo "EC2_HOST: ${EC2_HOST:-âŒ ì—†ìŒ}"
            echo "EC2_USER: ${EC2_USER:-âŒ ì—†ìŒ}"
            exit 1
          fi
          
          echo "ğŸ” ë°°í¬ ëŒ€ìƒ: $EC2_USER@$EC2_HOST"
          
          # ì§„ë‹¨ ì •ë³´ ì¶œë ¥
          echo "ğŸ” ì§„ë‹¨ ì •ë³´:"
          echo "  - GitHub Actions IP: $(curl -s https://api.ipify.org || echo 'í™•ì¸ ì‹¤íŒ¨')"
          echo "  - EC2 í˜¸ìŠ¤íŠ¸: $EC2_HOST"
          echo "  - EC2 ì‚¬ìš©ì: $EC2_USER"
          echo ""
          
          # DNS í•´ì„ í…ŒìŠ¤íŠ¸
          echo "ğŸ” DNS í•´ì„ í…ŒìŠ¤íŠ¸ ì¤‘..."
          if nslookup "$EC2_HOST" > /dev/null 2>&1; then
            echo "âœ… DNS í•´ì„ ì„±ê³µ"
          else
            echo "âš ï¸ DNS í•´ì„ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
          fi
          echo ""
          
          # í¬íŠ¸ ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸ” í¬íŠ¸ 22 ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
          if timeout 5 bash -c "</dev/tcp/$EC2_HOST/22" 2>/dev/null; then
            echo "âœ… í¬íŠ¸ 22 ì—´ë¦¼"
          else
            echo "âŒ í¬íŠ¸ 22 ë‹«í˜ ë˜ëŠ” íƒ€ì„ì•„ì›ƒ"
            echo "âš ï¸ EC2 ë³´ì•ˆ ê·¸ë£¹ì—ì„œ SSH(22ë²ˆ í¬íŠ¸)ê°€ GitHub Actions IPì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œì§€ í™•ì¸í•˜ì„¸ìš”."
            echo "   ìì„¸í•œ ë‚´ìš©: docs/SSH_CONNECTION_TIMEOUT_TROUBLESHOOTING.md"
          fi
          echo ""
          
          # SSH í‚¤ ìƒì„¸ í™•ì¸
          echo "ğŸ”‘ SSH í‚¤ ìƒì„¸ í™•ì¸:"
          if [ -f ~/.ssh/deploy_key ]; then
            echo "âœ… í‚¤ íŒŒì¼ ì¡´ì¬"
            echo "í‚¤ íŒŒì¼ ê¶Œí•œ: $(ls -l ~/.ssh/deploy_key | awk '{print $1}')"
            echo "í‚¤ íŒŒì¼ í¬ê¸°: $(wc -c < ~/.ssh/deploy_key) bytes"
            echo "í‚¤ íŒŒì¼ ì¤„ ìˆ˜: $(wc -l < ~/.ssh/deploy_key) ì¤„"
            echo "í‚¤ ì²« ì¤„: $(head -1 ~/.ssh/deploy_key)"
            echo "í‚¤ ë§ˆì§€ë§‰ ì¤„: $(tail -1 ~/.ssh/deploy_key)"
          else
            echo "âŒ í‚¤ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          echo ""
          
          # SSH í‚¤ í˜•ì‹ ê²€ì¦
          if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/deploy_key; then
            echo "âŒ SSH í‚¤ í˜•ì‹ ì˜¤ë¥˜: 'BEGIN PRIVATE KEY'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            echo "EC2_SSH_KEY Secretì´ ì˜¬ë°”ë¥¸ í˜•ì‹ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi
          
          if ! grep -q "END.*PRIVATE KEY" ~/.ssh/deploy_key; then
            echo "âŒ SSH í‚¤ í˜•ì‹ ì˜¤ë¥˜: 'END PRIVATE KEY'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            echo "EC2_SSH_KEY Secretì´ ì˜¬ë°”ë¥¸ í˜•ì‹ì¸ì§€ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi
          
          echo "âœ… SSH í‚¤ í˜•ì‹ ê²€ì¦ í†µê³¼"
          echo ""
          
          # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸ” SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
          echo "ì—°ê²° ëŒ€ìƒ: $EC2_USER@$EC2_HOST"
          echo ""
          
          SSH_OUTPUT=$(ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              -o LogLevel=DEBUG \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -v \
              "$EC2_USER@$EC2_HOST" \
              "echo 'SSH ì—°ê²° ì„±ê³µ!'" 2>&1)
          SSH_EXIT_CODE=$?
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ $SSH_EXIT_CODE -eq 0 ]; then
            echo "âœ… SSH ì—°ê²° ì„±ê³µ!"
          else
            echo "âŒ SSH ì—°ê²° ì‹¤íŒ¨! (exit code: $SSH_EXIT_CODE)"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ì˜¤ë¥˜ ìƒì„¸ (ì „ì²´):"
            echo "$SSH_OUTPUT"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ê°€ëŠ¥í•œ ì›ì¸:"
            echo "1. EC2_SSH_KEY Secretì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŒ (í‚¤ í˜•ì‹ ì˜¤ë¥˜ ë˜ëŠ” ì˜ëª»ëœ í‚¤)"
            echo "2. EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ authorized_keysì— í•´ë‹¹ ê³µê°œ í‚¤ê°€ ì—†ìŒ"
            echo "3. EC2 ì‚¬ìš©ìëª…(EC2_USER)ì´ ì˜ëª»ë¨"
            echo "4. SSH í‚¤ ê¶Œí•œ ë¬¸ì œ"
            echo ""
            echo "í•´ê²° ë°©ë²•:"
            echo "1. EC2_SSH_KEY Secret í™•ì¸:"
            echo "   - GitHub ì €ì¥ì†Œ â†’ Settings â†’ Secrets â†’ EC2_SSH_KEY"
            echo "   - ì²« ì¤„ì´ '-----BEGIN RSA PRIVATE KEY-----' ë˜ëŠ” '-----BEGIN OPENSSH PRIVATE KEY-----'ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸"
            echo "   - ë§ˆì§€ë§‰ ì¤„ì´ '-----END RSA PRIVATE KEY-----' ë˜ëŠ” '-----END OPENSSH PRIVATE KEY-----'ë¡œ ëë‚˜ëŠ”ì§€ í™•ì¸"
            echo "   - ì „ì²´ í‚¤ ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆëŠ”ì§€ í™•ì¸ (ì¤„ë°”ê¿ˆ í¬í•¨)"
            echo ""
            echo "2. EC2ì—ì„œ ê³µê°œ í‚¤ í™•ì¸ ë° ì¶”ê°€:"
            echo "   # ë¡œì»¬ì—ì„œ ê³µê°œ í‚¤ ì¶”ì¶œ:"
            echo "   ssh-keygen -y -f ~/.ssh/your-key.pem"
            echo "   # EC2ì— ì ‘ì†í•˜ì—¬ authorized_keys í™•ì¸:"
            echo "   ssh -i ~/.ssh/your-key.pem ubuntu@your-ec2-ip"
            echo "   cat ~/.ssh/authorized_keys"
            echo "   # ê³µê°œ í‚¤ê°€ ì—†ìœ¼ë©´ ì¶”ê°€:"
            echo "   echo 'ê³µê°œ-í‚¤-ë‚´ìš©' >> ~/.ssh/authorized_keys"
            echo ""
            echo "3. ë¡œì»¬ì—ì„œ SSH ì—°ê²° í…ŒìŠ¤íŠ¸:"
            echo "   ssh -i ~/.ssh/your-key.pem $EC2_USER@$EC2_HOST 'echo ì—°ê²° ì„±ê³µ'"
            echo ""
            echo "ìì„¸í•œ ë‚´ìš©: docs/SSH_KEY_TROUBLESHOOTING.md"
            exit 1
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # ë°°í¬ íŒŒì¼ ì „ì†¡
          echo "ğŸ“¤ ë°°í¬ íŒŒì¼ ì „ì†¡ ì¤‘..."
          scp -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              backend/deploy.tar.gz \
              "$EC2_USER@$EC2_HOST:/tmp/"

          # .env íŒŒì¼ ì—…ë¡œë“œ (GitHub Secrets ì‚¬ìš©)
          echo "ğŸ“¤ .env íŒŒì¼ ìƒì„± ì¤‘..."
          
          # í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ í™•ì¸
          if [ -z "${EC2_DATABASE_URL:-}" ]; then
            echo "âš ï¸ EC2_DATABASE_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. GitHub Secretsì— ì„¤ì •í•˜ì„¸ìš”."
            echo "   ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          if [ -z "${EC2_JWT_SECRET:-}" ]; then
            echo "âš ï¸ EC2_JWT_SECRETì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. GitHub Secretsì— ì„¤ì •í•˜ì„¸ìš”."
            echo "   ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              "$EC2_USER@$EC2_HOST" \
              "mkdir -p /home/ubuntu/chalog-backend && \
               echo 'DATABASE_URL=${EC2_DATABASE_URL}' > /home/ubuntu/chalog-backend/.env && \
               echo 'DB_SYNCHRONIZE=false' >> /home/ubuntu/chalog-backend/.env && \
               echo 'DB_SSL_ENABLED=true' >> /home/ubuntu/chalog-backend/.env && \
               echo 'DB_SSL_REJECT_UNAUTHORIZED=false' >> /home/ubuntu/chalog-backend/.env && \
               echo 'JWT_SECRET=${EC2_JWT_SECRET}' >> /home/ubuntu/chalog-backend/.env && \
               echo 'JWT_EXPIRES_IN=7d' >> /home/ubuntu/chalog-backend/.env && \
               echo 'PORT=3000' >> /home/ubuntu/chalog-backend/.env && \
               echo 'NODE_ENV=production' >> /home/ubuntu/chalog-backend/.env && \
               echo 'FRONTEND_URL=${EC2_FRONTEND_URL:-https://cha-log-gilt.vercel.app}' >> /home/ubuntu/chalog-backend/.env && \
               echo 'FRONTEND_URLS=${EC2_FRONTEND_URLS:-https://cha-log-gilt.vercel.app,http://localhost:5173,http://localhost:5174}' >> /home/ubuntu/chalog-backend/.env && \
               chmod 600 /home/ubuntu/chalog-backend/.env && \
               echo 'âœ… .env íŒŒì¼ ìƒì„± ì™„ë£Œ'"

          # EC2ì—ì„œ ë°°í¬ ì‹¤í–‰
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              "$EC2_USER@$EC2_HOST" << 'ENDSSH'
            set -e
            
            BACKEND_DIR="/home/ubuntu/chalog-backend"
            
            # curl ì„¤ì¹˜ í™•ì¸
            if ! command -v curl &> /dev/null; then
              echo "ğŸ“¦ curl ì„¤ì¹˜ ì¤‘..."
              sudo apt-get update
              sudo apt-get install -y curl
            fi
            
            # Node.js ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            if ! command -v node &> /dev/null || ! command -v npm &> /dev/null; then
              echo "ğŸ“¦ Node.js/npmì´ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì¹˜ ì¤‘..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
              
              # ëª…ë ¹ì–´ ìºì‹œ ìƒˆë¡œê³ ì¹¨
              hash -r
              
              # PATHì— Node.js ê²½ë¡œ ì¶”ê°€
              export PATH="/usr/bin:/usr/local/bin:$PATH"
              
              # ì„¤ì¹˜ í™•ì¸ (ì „ì²´ ê²½ë¡œë¡œë„ ì‹œë„)
              if command -v node &> /dev/null || [ -f /usr/bin/node ]; then
                NODE_CMD=$(command -v node || echo "/usr/bin/node")
                NPM_CMD=$(command -v npm || echo "/usr/bin/npm")
                
                if [ -f "$NODE_CMD" ] && [ -f "$NPM_CMD" ]; then
                  echo "âœ… Node.js ì„¤ì¹˜ ì™„ë£Œ: $($NODE_CMD --version)"
                  echo "âœ… npm ì„¤ì¹˜ ì™„ë£Œ: $($NPM_CMD --version)"
                  # ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„± (í•„ìš”ì‹œ)
                  [ ! -f /usr/local/bin/node ] && sudo ln -sf "$NODE_CMD" /usr/local/bin/node || true
                  [ ! -f /usr/local/bin/npm ] && sudo ln -sf "$NPM_CMD" /usr/local/bin/npm || true
                else
                  echo "âŒ Node.js/npm ì„¤ì¹˜ ì‹¤íŒ¨!"
                  echo "Node.js ê²½ë¡œ: $NODE_CMD"
                  echo "npm ê²½ë¡œ: $NPM_CMD"
                  exit 1
                fi
              else
                echo "âŒ Node.js/npm ì„¤ì¹˜ ì‹¤íŒ¨!"
                exit 1
              fi
            else
              echo "âœ… Node.js ì´ë¯¸ ì„¤ì¹˜ë¨: $(node --version)"
              echo "âœ… npm ì´ë¯¸ ì„¤ì¹˜ë¨: $(npm --version)"
            fi
            
            # npm ê²½ë¡œ í™•ì¸
            echo "ğŸ” npm ê²½ë¡œ: $(which npm || echo '/usr/bin/npm')"
            echo "ğŸ” node ê²½ë¡œ: $(which node || echo '/usr/bin/node')"
            
            # ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p $BACKEND_DIR
            cd $BACKEND_DIR
            
            # ê¸°ì¡´ íŒŒì¼ ë°±ì—…
            if [ -d "dist" ]; then
              echo "ğŸ’¾ ê¸°ì¡´ íŒŒì¼ ë°±ì—… ì¤‘..."
              BACKUP_DIR="/home/ubuntu/backups"
              mkdir -p $BACKUP_DIR
              tar -czf $BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).tar.gz \
                  dist/ package.json package-lock.json ecosystem.config.js 2>/dev/null || true
            fi
            
            # ë°°í¬ íŒŒì¼ ì••ì¶• í•´ì œ
            echo "ğŸ“¦ ë°°í¬ íŒŒì¼ ì••ì¶• í•´ì œ ì¤‘..."
            tar -xzf /tmp/deploy.tar.gz -C $BACKEND_DIR
            
            # ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            # npm ê²½ë¡œ í™•ì¸ í›„ ì‚¬ìš©
            NPM_CMD=$(command -v npm || echo "/usr/bin/npm")
            if [ ! -f "$NPM_CMD" ]; then
              echo "âŒ npmì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $NPM_CMD"
              exit 1
            fi
            
            # ê¸°ì¡´ node_modules ì •ë¦¬ (í•„ìš”ì‹œ)
            if [ -d "node_modules" ]; then
              echo "ğŸ§¹ ê¸°ì¡´ node_modules ì •ë¦¬ ì¤‘..."
              rm -rf node_modules
            fi
            
            # package-lock.json í™•ì¸
            if [ ! -f "package-lock.json" ]; then
              echo "âš ï¸ package-lock.jsonì´ ì—†ìŠµë‹ˆë‹¤. ìµœì‹  backend/package-lock.jsonì„ ì»¤ë°‹í•˜ì„¸ìš”."
              exit 1
            fi
            
            echo "ğŸ“¦ npm ci ì‹¤í–‰ ì¤‘..."
            if ! $NPM_CMD ci --legacy-peer-deps --no-audit --no-fund; then
              echo "âŒ npm ci ì‹¤íŒ¨! package-lock.jsonì„ í™•ì¸í•˜ì„¸ìš”."
              exit 1
            fi
            
            echo "ğŸ§¹ devDependencies ì œê±° ì¤‘..."
            $NPM_CMD prune --production
            
            echo "ğŸ” í•„ìˆ˜ íŒ¨í‚¤ì§€ í™•ì¸ ì¤‘..."
            REQUIRED_PACKAGES=("class-transformer" "class-validator" "rxjs" "typeorm" "@nestjs/common" "@nestjs/core" "mysql2")
            for pkg in "${REQUIRED_PACKAGES[@]}"; do
              if [ -d "node_modules/$pkg" ]; then
                echo "âœ… $pkg í™•ì¸ë¨"
              else
                echo "âŒ $pkg ëˆ„ë½ë¨! package.jsonì„ ì—…ë°ì´íŠ¸í•œ ë’¤ ë‹¤ì‹œ ë°°í¬í•˜ì„¸ìš”."
                exit 1
              fi
            done
            
            # PM2 ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            NPM_CMD=$(command -v npm || echo "/usr/bin/npm")
            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ“¦ PM2ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì¹˜ ì¤‘..."
              sudo $NPM_CMD install -g pm2
              hash -r
              PM2_CMD=$(command -v pm2 || echo "/usr/local/bin/pm2")
              if [ -f "$PM2_CMD" ]; then
                echo "âœ… PM2 ì„¤ì¹˜ ì™„ë£Œ: $($PM2_CMD --version)"
                
                # PM2 ë¶€íŒ… ì‹œ ìë™ ì‹œì‘ ì„¤ì •
                echo "âš™ï¸ PM2 ë¶€íŒ… ì‹œ ìë™ ì‹œì‘ ì„¤ì • ì¤‘..."
                $PM2_CMD startup systemd -u ubuntu --hp /home/ubuntu || echo "PM2 startup ì„¤ì •ì€ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
              else
                echo "âš ï¸ PM2 ì„¤ì¹˜ í›„ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                exit 1
              fi
            else
              PM2_CMD=$(command -v pm2)
              echo "âœ… PM2 ì´ë¯¸ ì„¤ì¹˜ë¨: $($PM2_CMD --version)"
            fi
            
            # PM2ë¡œ ì¬ì‹œì‘
            echo "ğŸ”„ PM2ë¡œ ì•± ì¬ì‹œì‘ ì¤‘..."
            $PM2_CMD delete chalog-backend 2>/dev/null || true
            
            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸
            if [ ! -f ".env" ]; then
              echo "âš ï¸ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ ì‚¬ìš©"
            else
              echo "âœ… .env íŒŒì¼ ì¡´ì¬"
            fi
            
            # PM2 ì‹œì‘
            $PM2_CMD start ecosystem.config.js
            $PM2_CMD save
            
            # ì‹œì‘ í™•ì¸
            sleep 2
            PM2_STATUS=$($PM2_CMD status | grep chalog-backend | awk '{print $10}')
            echo "ğŸ“Š PM2 ì´ˆê¸° ìƒíƒœ: $PM2_STATUS"
            
            # Health check
            echo "ğŸ¥ Health check..."
            sleep 10  # ì•± ì‹œì‘ ì‹œê°„ í™•ë³´
            PM2_CMD=$(command -v pm2 || echo "/usr/local/bin/pm2")
            
            # PM2 ìƒíƒœ í™•ì¸
            echo "ğŸ“Š PM2 ìƒíƒœ:"
            $PM2_CMD status || true
            
            # Health check ì‹œë„
            if curl -f http://localhost:3000/health > /dev/null 2>&1; then
              echo "âœ… ë°°í¬ ì„±ê³µ! Health check í†µê³¼"
            else
              echo "âš ï¸ Health check ì‹¤íŒ¨. ìƒì„¸ ì •ë³´ í™•ì¸:"
              echo "PM2 ìƒíƒœ:"
              $PM2_CMD status || true
              echo ""
              echo "PM2 ë¡œê·¸ (ìµœê·¼ 50ì¤„):"
              $PM2_CMD logs chalog-backend --lines 50 --nostream || true
              echo ""
              echo "node_modules/class-transformer í™•ì¸:"
              ls -la node_modules/class-transformer 2>&1 || echo "class-transformer ì—†ìŒ"
              echo ""
              echo "class-transformer íŒ¨í‚¤ì§€ ì •ë³´:"
              cat node_modules/class-transformer/package.json 2>&1 | head -10 || echo "íŒŒì¼ ì—†ìŒ"
              exit 1
            fi
            
            # ì •ë¦¬
            rm -f /tmp/deploy.tar.gz
          ENDSSH

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -rf backend/deploy-package backend/deploy.tar.gz

      - name: Deployment Summary
        if: success()
        run: |
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ Backend URL: http://${{ secrets.EC2_HOST }}:3000"
          echo "ğŸ¥ Health Check: http://${{ secrets.EC2_HOST }}:3000/health"

